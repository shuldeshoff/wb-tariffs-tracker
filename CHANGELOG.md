# Changelog

Все значимые изменения в проекте будут документированы в этом файле.

## [1.1.0] - 2025-10-22

### Добавлено

#### Тестирование
- Исправлена конфигурация Jest для корректной работы с ES Modules
- Добавлен mock для log4js
- Написаны unit тесты для wildberries.service (покрытие 90%)
- Написаны unit тесты для tariffs.repository (покрытие 82%)
- Написаны unit тесты для scheduler.service
- Написаны базовые тесты для data-processing.service
- Написаны базовые тесты для google-sheets.service
- Добавлен test конфиг в knexfile.ts
- Общее покрытие сервисов: 41.8%

#### HTTP Server и Health Checks
- Добавлен Express HTTP сервер
- Endpoint `/health` - комплексная проверка здоровья (БД + scheduler)
- Endpoint `/ready` - проверка готовности к работе
- Endpoint `/live` - проверка жизни приложения
- Endpoint `/status` - статус сервиса и scheduler
- Graceful shutdown для HTTP сервера

#### Prometheus Метрики
- Добавлена библиотека prom-client
- Endpoint `/metrics` - экспорт метрик в формате Prometheus
- Метрики WB API запросов (счётчики, гистограммы длительности)
- Метрики обновления Google Sheets (счётчики, гистограммы)
- Метрики обработки тарифов (счётчики)
- Метрики БД операций (гистограммы)
- Гауджи для времени последних успешных операций
- Гауджи для отслеживания активных задач

#### Интеграция метрик
- Интегрированы метрики в wildberries.service
- Интегрированы метрики в data-processing.service
- Интегрированы метрики в google-sheets.service
- Автоматический трекинг длительности операций

### Изменено
- Обновлена схема валидации env переменных (добавлен test mode)
- Добавлены значения по умолчанию для всех env переменных
- Обновлена документация (README.md)
- Добавлена секция "API Endpoints" в README
- Добавлена секция "Мониторинг и Метрики" в README
- Обновлена таблица переменных окружения

### Исправлено
- Исправлена конфигурация Jest для работы с алиасами импорта
- Исправлена обработка ошибок в shutdown процедуре
- Улучшена типизация в env схеме

## [1.0.0] - 2025-10-22

### Добавлено

#### Инфраструктура
- Настройка Docker Compose с PostgreSQL и Node.js
- Конфигурация TypeScript с поддержкой ES Modules
- Система логирования с использованием log4js
- Graceful shutdown для корректного завершения приложения

#### База данных
- Миграция для создания таблицы `tariffs`
- Уникальные индексы для предотвращения дубликатов
- Индексы для оптимизации запросов по дате и коэффициенту

#### Интеграция с Wildberries API
- Сервис для получения тарифов коробов
- Retry-логика с 3 попытками при сбоях
- Обработка ошибок и логирование запросов
- Парсинг коэффициентов из строковых выражений

#### Работа с базой данных
- Repository для работы с таблицей тарифов
- UPSERT операции для обновления данных текущего дня
- Методы получения актуальных тарифов с сортировкой
- Метод очистки старых данных

#### Интеграция с Google Sheets
- Аутентификация через Service Account
- Обновление произвольного количества таблиц
- Запись данных на лист `stocks_coefs`
- Автоматическая сортировка по коэффициенту
- Обработка ошибок доступа к таблицам

#### Планировщик задач
- Ежечасное получение данных от WB API (настраиваемо)
- Регулярное обновление Google Sheets (каждые 30 минут по умолчанию)
- Выполнение задач при запуске приложения
- Мониторинг и логирование выполнения задач

#### Документация
- Подробный README с инструкциями по установке и запуску
- Описание всех переменных окружения
- Руководство по настройке Google Service Account
- Примеры работы с миграциями
- Описание структуры БД

### Конфигурация
- Переменные окружения для всех внешних сервисов
- Настраиваемые cron-расписания
- Уровни логирования
- Параметры подключения к БД

### Типы
- TypeScript интерфейсы для WB API responses
- Типы для записей БД
- Типы для данных Google Sheets

### Тестирование
- Структура готова для добавления тестов

---

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
версионирование следует [Semantic Versioning](https://semver.org/lang/ru/).

